import{r as n,a as de,R as ue}from"./vendor-b1791c80.js";(function(){const h=document.createElement("link").relList;if(h&&h.supports&&h.supports("modulepreload"))return;for(const g of document.querySelectorAll('link[rel="modulepreload"]'))u(g);new MutationObserver(g=>{for(const f of g)if(f.type==="childList")for(const o of f.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&u(o)}).observe(document,{childList:!0,subtree:!0});function x(g){const f={};return g.integrity&&(f.integrity=g.integrity),g.referrerPolicy&&(f.referrerPolicy=g.referrerPolicy),g.crossOrigin==="use-credentials"?f.credentials="include":g.crossOrigin==="anonymous"?f.credentials="omit":f.credentials="same-origin",f}function u(g){if(g.ep)return;g.ep=!0;const f=x(g);fetch(g.href,f)}})();var ce={exports:{}},se={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var me=n,he=Symbol.for("react.element"),fe=Symbol.for("react.fragment"),pe=Object.prototype.hasOwnProperty,Ne=me.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,xe={key:!0,ref:!0,__self:!0,__source:!0};function ie(i,h,x){var u,g={},f=null,o=null;x!==void 0&&(f=""+x),h.key!==void 0&&(f=""+h.key),h.ref!==void 0&&(o=h.ref);for(u in h)pe.call(h,u)&&!xe.hasOwnProperty(u)&&(g[u]=h[u]);if(i&&i.defaultProps)for(u in h=i.defaultProps,h)g[u]===void 0&&(g[u]=h[u]);return{$$typeof:he,type:i,key:f,ref:o,props:g,_owner:Ne.current}}se.Fragment=fe;se.jsx=ie;se.jsxs=ie;ce.exports=se;var e=ce.exports,ne={},ae=de;ne.createRoot=ae.createRoot,ne.hydrateRoot=ae.hydrateRoot;function ge({onSongSelect:i,apiBase:h}){var d,v,S,b,F,T,L;const[x,u]=n.useState([]),[g,f]=n.useState(!0),[o,N]=n.useState(null);n.useState(!1),n.useEffect(()=>{y()},[]);const y=async()=>{try{const r=await(await fetch(`${h}/library`)).json();u(r)}catch(t){console.error("Failed to load library:",t)}finally{f(!1)}},R=async t=>{try{const r=await fetch(`${h}/library/${t.id}`);if(!r.ok){const _=await r.json().catch(()=>({}));console.error("Failed to load song details:",_.error||r.statusText),alert(`Failed to load song: ${_.error||r.statusText}`);return}const p=await r.json();N(p),i(p)}catch(r){console.error("Failed to load song details:",r),alert(`Failed to load song: ${r.message}`)}},A=t=>new Date(t).toLocaleDateString();return g?e.jsx("div",{className:"library-container",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("h2",{children:"LOADING LIBRARY..."})]})}):e.jsxs("div",{className:"library-container",children:[e.jsxs("div",{className:"library-header",children:[e.jsx("h1",{className:"neon-title",children:"ðŸŽµ SONG LIBRARY ðŸŽµ"}),e.jsx("div",{className:"library-controls",children:e.jsx("button",{className:"retro-button",onClick:y,children:"ðŸ”„ REFRESH"})})]}),e.jsx("div",{className:"library-content",children:x.length===0?e.jsxs("div",{className:"empty-library",children:[e.jsx("h2",{children:"ðŸŽ¤ NO SONGS IN LIBRARY"}),e.jsx("p",{children:"Place preprocessed references and videos to get started."})]}):e.jsx("div",{className:"songs-grid",children:x.map(t=>e.jsxs("div",{className:`song-card ${(o==null?void 0:o.id)===t.id?"selected":""}`,onClick:()=>R(t),children:[e.jsxs("div",{className:"song-info",children:[e.jsx("h3",{className:"song-title",children:t.name}),e.jsxs("p",{className:"song-date",children:["Added: ",A(t.uploaded_at)]}),e.jsx("div",{className:"song-status",children:e.jsx("span",{className:"status-badge ready",children:"âœ… READY"})})]}),e.jsx("div",{className:"song-actions",children:e.jsx("button",{className:"retro-button small",onClick:r=>{r.stopPropagation(),R(t)},children:"ðŸŽ¤ SING"})})]},t.id))})}),o&&e.jsxs("div",{className:"song-details",children:[e.jsxs("h3",{children:["Selected: ",o.name]}),e.jsxs("div",{className:"song-metadata",children:[e.jsxs("div",{className:"metadata-item",children:[e.jsx("span",{className:"label",children:"Duration:"}),e.jsxs("span",{className:"value",children:[(v=(d=o.reference_data)==null?void 0:d.duration)==null?void 0:v.toFixed(1),"s"]})]}),e.jsxs("div",{className:"metadata-item",children:[e.jsx("span",{className:"label",children:"Tempo:"}),e.jsxs("span",{className:"value",children:[(b=(S=o.reference_data)==null?void 0:S.tempo)==null?void 0:b.toFixed(1)," BPM"]})]}),e.jsxs("div",{className:"metadata-item",children:[e.jsx("span",{className:"label",children:"Key:"}),e.jsx("span",{className:"value",children:(F=o.reference_data)==null?void 0:F.key})]}),e.jsxs("div",{className:"metadata-item",children:[e.jsx("span",{className:"label",children:"Phrases:"}),e.jsx("span",{className:"value",children:(L=(T=o.reference_data)==null?void 0:T.phrases)==null?void 0:L.length})]})]})]})]})}const Ee=({songData:i,apiBase:h,onTimeUpdate:x,onStartSession:u,onSessionComplete:g,isSessionActive:f,onSessionToggle:o})=>{var Q,Z,B;const N=n.useRef(null),[y,R]=n.useState(!1),[A,d]=n.useState(0),[v,S]=n.useState(0),[b,F]=n.useState(.7),[T,L]=n.useState(!1),t=n.useRef(null),r=n.useRef(f),p=n.useRef(null),[_,Y]=n.useState(!1);n.useEffect(()=>{r.current=f},[f]);const W=i!=null&&i.karaoke_video?`${h}${i.karaoke_video.startsWith("/")?"":"/"}${i.karaoke_video}`:null,$=i!=null&&i.reference_vocals?`${h}${i.reference_vocals.startsWith("/")?"":"/"}${i.reference_vocals}`:null,D=n.useCallback((m,M)=>{if(!N.current)return;const s=N.current,a=M?M.mediaTime:s.currentTime;d(a),x&&x(a),!s.paused&&!s.ended&&s.requestVideoFrameCallback&&(t.current=s.requestVideoFrameCallback(D))},[x]),G=n.useCallback(()=>{if(!N.current)return;const m=N.current;d(m.currentTime),x&&x(m.currentTime)},[x]);n.useEffect(()=>{const m=N.current;if(!m)return;const M=()=>{S(m.duration),L(!0),console.log("Video ready:",{duration:m.duration,videoWidth:m.videoWidth,videoHeight:m.videoHeight})},s=()=>{R(!0),m.requestVideoFrameCallback&&(t.current=m.requestVideoFrameCallback(D)),_&&p.current&&(p.current.currentTime=m.currentTime,p.current.play().catch(()=>{}))},a=()=>{R(!1),t.current!==null&&m.cancelVideoFrameCallback&&(m.cancelVideoFrameCallback(t.current),t.current=null),p.current&&!p.current.paused&&p.current.pause()},c=()=>{R(!1),r.current&&o&&o(!1),p.current&&(p.current.pause(),p.current.currentTime=0)};return m.addEventListener("loadedmetadata",M),m.addEventListener("play",s),m.addEventListener("pause",a),m.addEventListener("ended",c),m.addEventListener("timeupdate",G),()=>{m.removeEventListener("loadedmetadata",M),m.removeEventListener("play",s),m.removeEventListener("pause",a),m.removeEventListener("ended",c),m.removeEventListener("timeupdate",G),t.current!==null&&m.cancelVideoFrameCallback&&m.cancelVideoFrameCallback(t.current)}},[D,G,f,o,_]),n.useEffect(()=>{N.current&&(N.current.volume=b)},[b]);const q=n.useCallback(async()=>{const m=N.current;if(m)try{m.paused?(await m.play(),console.log("Video play started successfully")):(m.pause(),console.log("Video paused"))}catch(M){console.error("Video play/pause error:",M),alert(`Video playback error: ${M.message}`)}},[]),U=n.useCallback(m=>{const M=N.current;if(!M)return;const s=m.currentTarget.getBoundingClientRect(),l=(m.clientX-s.left)/s.width*v;M.currentTime=l,d(l),x&&x(l),p.current&&(p.current.currentTime=l,_&&!M.paused&&p.current.play().catch(()=>{}))},[v,x,_]),w=async()=>{if(r.current)o&&o(!1),N.current&&!N.current.paused&&N.current.pause(),p.current&&!p.current.paused&&p.current.pause();else if(u&&await u(),o&&o(!0),N.current&&N.current.paused)try{await N.current.play(),console.log("Auto-play started for session")}catch(m){console.error("Auto-play failed:",m),alert(`Auto-play failed: ${m.message}. Please click play manually.`)}},z=m=>{const M=Math.floor(m/60),s=Math.floor(m%60);return`${M}:${s.toString().padStart(2,"0")}`};return i?e.jsxs("div",{className:"video-karaoke-player",children:[e.jsxs("div",{className:"video-container",children:[e.jsx("video",{ref:N,className:"karaoke-video",src:W,crossOrigin:"anonymous",playsInline:!0,children:"Your browser does not support the video tag."}),e.jsx("div",{className:"video-overlay",children:e.jsx("button",{className:"play-pause-overlay",onClick:q,"aria-label":y?"Pause":"Play",children:y?"â¸ï¸":"â–¶ï¸"})})]}),e.jsxs("div",{className:"playback-controls",children:[e.jsxs("div",{className:"progress-section",children:[e.jsx("span",{className:"time-display",children:z(A)}),e.jsx("div",{className:"progress-bar",onClick:U,children:e.jsx("div",{className:"progress-fill",style:{width:`${A/v*100}%`}})}),e.jsx("span",{className:"time-display",children:z(v)})]}),e.jsxs("div",{className:"control-buttons",children:[e.jsx("button",{className:"control-btn",onClick:q,disabled:!T,children:y?"â¸ï¸ PAUSE":"â–¶ï¸ PLAY"}),e.jsx("button",{className:`control-btn ${f?"active":""}`,onClick:w,disabled:!T,children:f?"â¹ï¸ STOP SESSION":"ðŸŽ¤ START SESSION"}),e.jsxs("div",{className:"volume-control",children:[e.jsx("span",{className:"volume-icon",children:"ðŸ”Š"}),e.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:b,onChange:m=>F(parseFloat(m.target.value)),className:"volume-slider"})]}),$&&e.jsx("button",{className:`control-btn ${_?"active":""}`,onClick:()=>{var M,s;const m=!_;Y(m),p.current&&(p.current.currentTime=((M=N.current)==null?void 0:M.currentTime)||0,m&&!((s=N.current)!=null&&s.paused)?p.current.play().catch(()=>{}):p.current.pause())},disabled:!T,children:_?"ðŸ”‡ MUTE REF VOCALS":"ðŸ”ˆ PLAY REF VOCALS"})]}),e.jsxs("div",{className:"song-info",children:[e.jsx("h3",{children:i.name||i.song_name||i.title||"Untitled Song"}),e.jsxs("div",{className:"song-metadata",children:[((Q=i.reference_data)==null?void 0:Q.tempo)&&e.jsxs("span",{className:"metadata-item",children:["â™© ",Math.round(i.reference_data.tempo)," BPM"]}),((Z=i.reference_data)==null?void 0:Z.key)&&e.jsxs("span",{className:"metadata-item",children:["ðŸŽ¹ ",i.reference_data.key]}),((B=i.reference_data)==null?void 0:B.duration)&&e.jsxs("span",{className:"metadata-item",children:["â±ï¸ ",Math.floor(i.reference_data.duration/60),":",String(Math.floor(i.reference_data.duration%60)).padStart(2,"0")]})]})]})]}),$&&e.jsx("audio",{ref:p,src:$,crossOrigin:"anonymous"})]}):e.jsx("div",{className:"video-karaoke-player",children:e.jsx("div",{className:"no-song",children:e.jsx("p",{children:"No song selected"})})})},Se=({referenceData:i,externalTime:h,isSessionActive:x,onSessionComplete:u})=>{const g=n.useRef(null),f=n.useRef(null),o=n.useRef(null),N=n.useRef(null),y=n.useRef(x);n.useEffect(()=>{y.current=x},[x]);const[R,A]=n.useState({total:0,pitch:0,energy:0}),[d,v]=n.useState({frequency:0,confidence:0,centsError:0,combo:0,energyMatch:0}),S=n.useRef({pitchSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,frequencies:[],energies:[]}),b=n.useRef({detectedOffset:0,confidence:0,samples:[]}),F=n.useRef({minEnergySeen:1/0,maxEnergySeen:0,initialized:!1}),T=n.useRef({centsErrorBuffer:[],maxBufferSize:10}),L=n.useRef(x),t={PITCH_WEIGHT:.7,ENERGY_WEIGHT:.3,PITCH_PERFECT_CENTS:50,PITCH_GOOD_CENTS:100,PITCH_ACCEPTABLE_CENTS:200,KEY_SHIFT_MIN_SAMPLES:10,KEY_SHIFT_TOLERANCE:100,KEY_SHIFT_MAX_OFFSET:200,ENERGY_MIN_THRESHOLD:.005,ENERGY_SMOOTHING_WINDOW:5,COMBO_THRESHOLD:.6,COMBO_BREAK_THRESHOLD:.2,EMA_ALPHA:.2,BACKBUFFER_MS:350,PITCH_FLOOR:.15,ENERGY_FLOOR:.1,MIN_CONFIDENCE:.2,LOW_CONFIDENCE_FLOOR:.3},r=n.useCallback(async()=>{try{console.log("Initializing audio processing with AEC..."),f.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3,latencyHint:"interactive"});const s=f.current;try{await s.audioWorklet.addModule("/workers/pitch-processor-aec.js"),console.log("âœ… AudioWorklet loaded successfully")}catch(l){console.warn("Failed to load AudioWorklet, using fallback:",l),console.log("Continuing without AudioWorklet - basic audio processing only")}const a=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!1,sampleRate:48e3,channelCount:1}}).catch(async l=>(console.warn("Failed to get microphone with constraints, trying fallback:",l),await navigator.mediaDevices.getUserMedia({audio:!0})));N.current=a;const c=s.createMediaStreamSource(a);try{const l=new AudioWorkletNode(s,"pitch-processor-aec");o.current=l,l.port.onmessage=E=>{E.data.type==="audio-data"&&p(E.data)},c.connect(l),l.connect(s.destination),console.log("âœ… AudioWorklet processing initialized")}catch(l){console.warn("AudioWorklet failed, using basic audio monitoring:",l),c.connect(s.destination);const E=setInterval(()=>{y.current?p({frequency:440,confidence:.8,energy:.5,centroid:1e3,aecReduction:.1,timestamp:Date.now()}):clearInterval(E)},100);console.log("âœ… Basic audio monitoring initialized")}}catch(s){console.error("Failed to initialize audio:",s),s.name==="NotAllowedError"?alert("Microphone access denied. Please allow microphone access and refresh the page."):s.name==="NotFoundError"?alert("No microphone found. Please connect a microphone and refresh the page."):s.name==="NotSupportedError"?alert("AudioWorklet not supported. Please use HTTPS or a modern browser (Chrome, Firefox, Safari)."):alert(`Audio initialization failed: ${s.message}. Please check your microphone and browser settings.`),v(a=>({...a,frequency:0,confidence:0,error:s.message}))}},[]),p=n.useCallback(s=>{if(console.log("ðŸŽ¤ Audio data received:",s),!y.current||!i){console.log("Session not active or no reference data");return}const{frequency:a,confidence:c,energy:l,centroid:E,aecReduction:O}=s,j=h,C=_(j);if(!C)return;const k=Y(a,c,C,j),P=W(l,C),H=k*t.PITCH_WEIGHT+P*t.ENERGY_WEIGHT;D(H),S.current.pitchSamples.push(k),S.current.energySamples.push(P),S.current.timestamps.push(j),S.current.frequencies.push(a),S.current.energies.push(l);const V=$(a,C.f0);v({frequency:a,confidence:c,centsError:V,combo:S.current.maxCombo,energyMatch:P}),A(I=>({total:G(I.total,H*100,t.EMA_ALPHA),pitch:G(I.pitch,k*100,t.EMA_ALPHA),energy:G(I.energy,P*100,t.EMA_ALPHA)}))},[i,h]),_=n.useCallback(s=>{if(!i||!i.f0_ref_on_k)return null;const a=i.fps||50,c=Math.floor(s*a);if(c<0||c>=i.f0_ref_on_k.length)return null;const l=i.f0_ref_on_k[c],E=i.beats_k||[],O=E.reduce((k,P)=>Math.abs(P-s)<Math.abs(k-s)?P:k,E[0]||0),j=i.loudness_ref||[],C=j[Math.floor(c*j.length/i.f0_ref_on_k.length)];return{f0:(l==null?void 0:l.f0)||0,conf:(l==null?void 0:l.conf)||0,nearestBeat:O,beatDistance:Math.abs(s-O),loudness:(C==null?void 0:C.LUFS)||-30}},[i]),Y=n.useCallback((s,a,c,l)=>{if(s===0||c.f0===0)return t.PITCH_FLOOR;if(a<t.MIN_CONFIDENCE)return Math.max(t.PITCH_FLOOR,t.LOW_CONFIDENCE_FLOOR);let E=$(s,c.f0);if(b.current.samples.push(E),b.current.samples.length>t.KEY_SHIFT_MIN_SAMPLES){b.current.samples.length>20&&b.current.samples.shift();const C=q(b.current.samples);Math.abs(C)>t.KEY_SHIFT_TOLERANCE&&Math.abs(C)<t.KEY_SHIFT_MAX_OFFSET&&(b.current.detectedOffset=C,b.current.confidence=.8,E-=C)}T.current.centsErrorBuffer.push(E),T.current.centsErrorBuffer.length>T.current.maxBufferSize&&T.current.centsErrorBuffer.shift();const O=q(T.current.centsErrorBuffer),j=Math.abs(O);if(j<=t.PITCH_PERFECT_CENTS)return .95+.05*(1-j/t.PITCH_PERFECT_CENTS);if(j<=t.PITCH_GOOD_CENTS)return .95-.15*((j-t.PITCH_PERFECT_CENTS)/(t.PITCH_GOOD_CENTS-t.PITCH_PERFECT_CENTS));if(j<=t.PITCH_ACCEPTABLE_CENTS)return .8-.4*((j-t.PITCH_GOOD_CENTS)/(t.PITCH_ACCEPTABLE_CENTS-t.PITCH_GOOD_CENTS));{const k=.4-(j-t.PITCH_ACCEPTABLE_CENTS)*.002;return Math.max(t.PITCH_FLOOR,k)}},[]),W=n.useCallback((s,a)=>{if(s<t.ENERGY_MIN_THRESHOLD){const O=s/t.ENERGY_MIN_THRESHOLD,j=t.ENERGY_FLOOR+O*(.2-t.ENERGY_FLOOR);return Math.min(.2,j)}const c=F.current;if(!c.initialized)return c.minEnergySeen=s,c.maxEnergySeen=s,c.initialized=!0,.1;s>c.maxEnergySeen&&(c.maxEnergySeen=s),s<c.minEnergySeen&&s>=t.ENERGY_MIN_THRESHOLD&&(c.minEnergySeen=s);const l=c.maxEnergySeen-c.minEnergySeen;if(l<.001){const O=Math.log10(s+1e-10),j=Math.log10(t.ENERGY_MIN_THRESHOLD+1e-10),k=Math.log10(c.maxEnergySeen+1e-10)-j;if(k<.1){const H=Math.min(1,(s-t.ENERGY_MIN_THRESHOLD)/(c.maxEnergySeen-t.ENERGY_MIN_THRESHOLD+.001));return Math.max(t.ENERGY_FLOOR,H)}const P=(O-j)/k;return Math.max(t.ENERGY_FLOOR,Math.min(1,P))}const E=(s-c.minEnergySeen)/l;return Math.max(t.ENERGY_FLOOR,Math.min(1,E))},[]),$=(s,a)=>s===0||a===0?0:1200*Math.log2(s/a),D=s=>{if(s>=t.COMBO_THRESHOLD){const a=(S.current.combos[S.current.combos.length-1]||0)+1;S.current.combos.push(a),S.current.maxCombo=Math.max(S.current.maxCombo,a)}else s<t.COMBO_BREAK_THRESHOLD&&S.current.combos.push(0)},G=(s,a,c)=>c*a+(1-c)*s,q=s=>{if(s.length===0)return 0;const a=[...s].sort((l,E)=>l-E),c=Math.floor(a.length/2);return a.length%2===0?(a[c-1]+a[c])/2:a[c]};n.useEffect(()=>{const s=g.current;if(!s)return;const a=s.getContext("2d"),c=s.width,l=s.height,E=()=>{a.fillStyle="#000",a.fillRect(0,0,c,l),U(a,c,l),z(a,c,l),Q(a,c,l),Z(a),requestAnimationFrame(E)};E()},[d,R,i]);const U=(s,a,c)=>{var O;const l=c*.3,E=c*.4;if(s.strokeStyle="#0ff",s.lineWidth=2,s.strokeRect(50,l,a-100,E),i&&d.frequency>0){const j=((O=_(h))==null?void 0:O.f0)||0;if(j>0){const C=w(j,l,E);s.strokeStyle="#f0f",s.lineWidth=2,s.beginPath(),s.moveTo(50,C),s.lineTo(a-50,C),s.stroke();const k=w(d.frequency,l,E);s.fillStyle=d.confidence>.5?"#0f0":"#ff0",s.beginPath(),s.arc(a/2,k,10,0,Math.PI*2),s.fill()}}},w=(s,a,c)=>{const O=Math.log2(s),j=Math.log2(100),C=Math.log2(800),k=(O-j)/(C-j);return a+c*(1-k)},z=(s,a,c)=>{const l=c*.75,E=400,O=20,j=(a-E)/2;s.fillStyle="#333",s.fillRect(j,l,E,O),s.strokeStyle="#fff",s.lineWidth=2,s.beginPath(),s.moveTo(a/2,l),s.lineTo(a/2,l+O),s.stroke();const C=50,k=d.centsError/C*(E/2),P=a/2+k,H=Math.abs(d.centsError);let V="#0f0";H>25&&(V="#ff0"),H>50&&(V="#f00"),s.fillStyle=V,s.fillRect(P-3,l,6,O),s.fillStyle="#fff",s.font="14px monospace",s.textAlign="center",s.fillText(`${d.centsError.toFixed(0)} Â¢`,a/2,l+O+20)},Q=(s,a,c)=>{d.combo>5&&(s.fillStyle="#ff0",s.font="bold 48px monospace",s.textAlign="center",s.fillText(`${d.combo}x COMBO!`,a/2,c*.15))},Z=(s,a,c)=>{s.fillStyle="#0ff",s.font="bold 24px monospace",s.textAlign="left";const l=20,E=30;s.fillText(`TOTAL: ${R.total.toFixed(0)}%`,l,E),s.fillText(`PITCH: ${R.pitch.toFixed(0)}%`,l,E+30),s.fillText(`ENERGY: ${R.energy.toFixed(0)}%`,l,E+60)},B=s=>s.length===0?0:s.reduce((a,c)=>a+c,0)/s.length,m=s=>{if(s.length===0)return 0;const a=B(s),c=s.reduce((l,E)=>l+Math.pow(E-a,2),0)/s.length;return Math.sqrt(c)},M=n.useCallback(()=>{const s=S.current;if(s.timestamps.length===0)return console.warn("No performance data collected"),null;const a=B(s.pitchSamples)*100,c=B(s.energySamples)*100,l=a*t.PITCH_WEIGHT+c*t.ENERGY_WEIGHT,E=s.timestamps.map((I,X)=>({time:I,score:s.pitchSamples[X]*100})),O=s.timestamps.map((I,X)=>({time:I,energy:s.energies[X]})),j=[];s.maxCombo>=50&&j.push({name:"Combo King",description:`${s.maxCombo}x combo streak!`}),(s.energies.length>0?1-m(s.energies)/(B(s.energies)+.001):0)>=.9&&j.push({name:"Mic Melter",description:"Sustained energy!"}),(s.pitchSamples.length>0?1-m(s.pitchSamples)/(B(s.pitchSamples)+.001):0)>=.9&&a>=80&&j.push({name:"Smooth Operator",description:"Consistent pitch!"});const P=[],H=10,V=Math.max(...s.timestamps);for(let I=0;I<V;I+=H){const X=Math.min(I+H,V),te=s.timestamps.map((K,ee)=>K>=I&&K<X?ee:-1).filter(K=>K>=0);if(te.length>0){const K=B(te.map(re=>s.pitchSamples[re]))*100,ee=B(te.map(re=>s.energySamples[re]))*100,le=K*t.PITCH_WEIGHT+ee*t.ENERGY_WEIGHT;P.push({phrase:Math.floor(I/H),start:I,end:X,pitchScore:K,energyScore:ee,totalScore:le})}}return{totals:{total:l,pitch:a,energy:c,motion:0},badges:j,graphs:{pitchTimeline:E,energyGraph:O},perPhrase:P,performance_data:s}},[]);return n.useEffect(()=>{if(L.current&&!x&&S.current.timestamps.length>0){console.log("ðŸŽ¤ Session ended, computing final results...");const s=M();s&&u&&(console.log("ðŸŽ¤ Final results:",s),u(s))}L.current=x},[x,M,u]),n.useEffect(()=>(y.current?(console.log("ðŸŽ¤ Session active, initializing audio processing..."),L.current||(console.log("ðŸŽ¤ Resetting performance data for new session"),S.current={pitchSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,frequencies:[],energies:[]},b.current={detectedOffset:0,confidence:0,samples:[]},F.current={minEnergySeen:1/0,maxEnergySeen:0,initialized:!1},T.current={centsErrorBuffer:[],maxBufferSize:10}),f.current?(console.log("ðŸŽ¤ Audio context already exists, ensuring processing is active"),o.current?console.log("ðŸŽ¤ AudioWorklet is active"):(console.log("ðŸŽ¤ AudioWorklet not active, reinitializing..."),r())):r()):(console.log("ðŸŽ¤ Session inactive, stopping audio processing"),N.current&&(N.current.getTracks().forEach(s=>s.stop()),N.current=null),f.current&&f.current.state!=="closed"&&(f.current.close().catch(()=>{}),f.current=null),o.current=null),()=>{N.current&&N.current.getTracks().forEach(s=>s.stop()),f.current&&f.current.state!=="closed"&&f.current.close().catch(()=>{})}),[x,r]),e.jsxs("div",{className:"live-hud",children:[e.jsx("canvas",{ref:g,width:1200,height:600,className:"hud-canvas"}),b.current.confidence>.5&&e.jsxs("div",{className:"key-shift-indicator",children:["Key shifted: ",b.current.detectedOffset>0?"+":"",b.current.detectedOffset.toFixed(0)," cents"]})]})};function je({onComplete:i}){const[h,x]=n.useState(null),[u,g]=n.useState(0),[f,o]=n.useState(!1),N=n.useRef(null),y=n.useRef(null),R=n.useRef(null);n.useRef(null);const A=n.useRef(null);n.useEffect(()=>()=>{A.current&&cancelAnimationFrame(A.current),R.current&&R.current.getTracks().forEach(r=>r.stop())},[]);const d=async()=>{try{const r=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});R.current=r,x(!0),v(r)}catch(r){console.error("Microphone access denied:",r),x(!1)}},v=r=>{try{console.log("Setting up audio analysis with stream:",r),N.current=new(window.AudioContext||window.webkitAudioContext),N.current.state==="suspended"&&N.current.resume().catch(()=>{}),y.current=N.current.createAnalyser(),N.current.createMediaStreamSource(r).connect(y.current),y.current.fftSize=256,y.current.smoothingTimeConstant=.8,console.log("Audio analyser configured:",{fftSize:y.current.fftSize,frequencyBinCount:y.current.frequencyBinCount,sampleRate:N.current.sampleRate}),S()}catch(p){console.error("Audio analysis setup failed:",p)}},S=()=>{const r=new Uint8Array(y.current.frequencyBinCount),p=new Uint8Array(y.current.fftSize),_=()=>{if(y.current){y.current.getByteFrequencyData(r),y.current.getByteTimeDomainData(p);let Y=0;for(let w=0;w<r.length;w++)Y+=r[w]*r[w];const W=Math.sqrt(Y/Math.max(1,r.length));let $=0;for(let w=0;w<p.length;w++){const z=p[w]-128;$+=z*z}const D=Math.sqrt($/Math.max(1,p.length)),G=Math.max(W/2,D),q=Math.min(G/32,1),U=Math.max(q,.02);Math.random()<.01&&console.log("Audio level debug:",{rmsFreq:W,rmsTime:D,rms:G,normalizedLevel:q,displayLevel:U}),g(U),A.current=requestAnimationFrame(_)}};_()},b=()=>{o(!0)},F=()=>{o(!1)},T=()=>{i()},L=()=>u<.1?"#ff3d00":u<.3?"#ffd700":u<.7?"#39ff14":"#ff00e6",t=()=>u<.1?"TOO QUIET":u<.3?"GETTING THERE":u<.7?"PERFECT":"TOO LOUD";return e.jsxs("div",{className:"mic-check-container",children:[e.jsxs("div",{className:"mic-check-header",children:[e.jsx("h2",{className:"neon-text",children:"ðŸŽ¤ MIC CHECK ðŸŽ¤"}),e.jsx("p",{children:"Let's make sure everything is working perfectly!"})]}),e.jsxs("div",{className:"mic-check-content",children:[e.jsxs("div",{className:"mic-section",children:[e.jsx("h3",{children:"Microphone"}),h===null&&e.jsx("button",{className:"retro-button large",onClick:d,children:"ðŸŽ¤ ENABLE MICROPHONE"}),h===!1&&e.jsxs("div",{className:"permission-denied",children:[e.jsx("p",{children:"âŒ Microphone access denied"}),e.jsx("p",{children:"Please allow microphone access to continue"}),e.jsx("button",{className:"retro-button",onClick:d,children:"TRY AGAIN"})]}),h===!0&&e.jsxs("div",{className:"mic-status",children:[e.jsx("div",{className:"audio-level-display",children:e.jsx("div",{className:"audio-level-bar",style:{height:`${u*100}%`,backgroundColor:L()}})}),e.jsxs("div",{className:"audio-level-info",children:[e.jsx("p",{className:`level-text ${t().replace(" ","-").toLowerCase()}`,children:t()}),e.jsxs("p",{className:"level-value",children:[(u*100).toFixed(0),"%"]})]}),e.jsx("div",{className:"mic-controls",children:f?e.jsx("button",{className:"retro-button",onClick:F,children:"â¹ï¸ STOP LISTENING"}):e.jsx("button",{className:"retro-button",onClick:b,children:"ðŸŽµ START LISTENING"})})]})]}),e.jsxs("div",{className:"instructions",children:[e.jsx("h4",{children:"Instructions:"}),e.jsxs("ul",{children:[e.jsx("li",{children:"ðŸŽ¤ Enable microphone and test your audio levels"}),e.jsx("li",{children:"ðŸ“¹ Optionally enable motion tracking for bonus points"}),e.jsx("li",{children:"ðŸŽµ Sing a few notes to test your setup"}),e.jsx("li",{children:"âœ¨ When ready, proceed to the live performance!"})]})]}),h===!0&&e.jsxs("div",{className:"proceed-section",children:[e.jsx("button",{className:"retro-button large proceed",onClick:T,disabled:u<.02,children:"ðŸš€ START PERFORMANCE"}),u<.02&&e.jsx("p",{className:"warning",children:"âš ï¸ Please test your microphone first"})]})]})]})}function ye({apiBase:i,onBack:h,onNewSession:x}){const[u,g]=n.useState([]),[f,o]=n.useState(!0);n.useEffect(()=>{N()},[]);const N=async()=>{try{const v=await(await fetch(`${i}/leaderboard?limit=20`)).json();g(v)}catch(d){console.error("Failed to load leaderboard:",d)}finally{o(!1)}},y=d=>d===1?"ðŸ¥‡":d===2?"ðŸ¥ˆ":d===3?"ðŸ¥‰":`#${d}`,R=d=>d>=90?"#39ff14":d>=80?"#ffd700":d>=70?"#ff9500":"#ff3d00",A=d=>{const v=new Date(d);return v.toLocaleDateString()+" "+v.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})};return f?e.jsx("div",{className:"leaderboard-container",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("h2",{children:"LOADING LEADERBOARD..."})]})}):e.jsxs("div",{className:"leaderboard-container",children:[e.jsxs("div",{className:"leaderboard-header",children:[e.jsx("h1",{className:"neon-title",children:"ðŸ† LEADERBOARD ðŸ†"}),e.jsx("p",{className:"leaderboard-subtitle",children:"Top performers in the arcade!"})]}),e.jsx("div",{className:"leaderboard-content",children:u.length===0?e.jsxs("div",{className:"empty-leaderboard",children:[e.jsx("h2",{children:"ðŸŽ¤ NO SCORES YET"}),e.jsx("p",{children:"Be the first to submit a score!"}),e.jsx("button",{className:"retro-button large",onClick:x,children:"START SINGING"})]}):e.jsx("div",{className:"leaderboard-list",children:u.map((d,v)=>e.jsxs("div",{className:`leaderboard-entry ${v<3?"top-three":""}`,children:[e.jsx("div",{className:"rank",children:e.jsx("span",{className:"rank-icon",children:y(v+1)})}),e.jsxs("div",{className:"player-info",children:[e.jsx("h3",{className:"player-name",children:d.player_name}),e.jsx("p",{className:"play-date",children:A(d.played_at)})]}),e.jsxs("div",{className:"score-info",children:[e.jsx("div",{className:"total-score",style:{color:R(d.total_score)},children:Math.round(d.total_score)}),e.jsxs("div",{className:"score-breakdown",children:[e.jsxs("span",{children:["P: ",Math.round(d.pitch_score)]}),e.jsxs("span",{children:["E: ",Math.round(d.energy_score)]})]})]}),e.jsx("div",{className:"badges",children:d.badges&&d.badges.length>0&&e.jsx("div",{className:"badge-list",children:d.badges.map((S,b)=>e.jsxs("span",{className:"badge-mini",children:[S.name==="Combo King"&&"ðŸ‘‘",S.name==="Mic Melter"&&"ðŸ”¥",S.name==="Smooth Operator"&&"ðŸŽµ"]},b))})})]},d.id))})}),e.jsxs("div",{className:"leaderboard-actions",children:[e.jsx("button",{className:"retro-button",onClick:h,children:"â† BACK TO RESULTS"}),e.jsx("button",{className:"retro-button",onClick:x,children:"ðŸŽµ NEW SONG"}),e.jsx("button",{className:"retro-button",onClick:N,children:"ðŸ”„ REFRESH"})]}),e.jsxs("div",{className:"leaderboard-stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"TOTAL PLAYERS"}),e.jsx("span",{className:"stat-value",children:u.length})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"HIGHEST SCORE"}),e.jsx("span",{className:"stat-value",children:u.length>0?Math.round(u[0].total_score):0})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"AVERAGE SCORE"}),e.jsx("span",{className:"stat-value",children:u.length>0?Math.round(u.reduce((d,v)=>d+v.total_score,0)/u.length):0})]})]})]})}function ve({sessionId:i,results:h,apiBase:x,onNewSession:u,playerName:g,onPlayerNameChange:f}){const[o,N]=n.useState(h||null),[y,R]=n.useState(!h&&!!i),[A,d]=n.useState(!1),[v,S]=n.useState(!1);n.useEffect(()=>{h?(N(h),R(!1)):i&&b()},[i,h]);const b=async()=>{try{const r=await(await fetch(`${x}/sessions/${i}/results`)).json();N(r.results||r)}catch(t){console.error("Failed to load results:",t)}finally{R(!1)}},F=async()=>{if(!g.trim()){alert("Please enter your name!");return}try{(await fetch(`${x}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:i,player_name:g,scores:o.totals,badges:o.badges})})).ok&&(S(!0),d(!0))}catch(t){console.error("Failed to submit to leaderboard:",t),alert("Failed to submit to leaderboard")}},T=t=>t>=90?"#39ff14":t>=70?"#ffd700":t>=50?"#ff9500":"#ff3d00",L=t=>t>=95?"S+":t>=90?"S":t>=85?"A+":t>=80?"A":t>=75?"B+":t>=70?"B":t>=65?"C+":t>=60?"C":t>=50?"D":"F";return y?e.jsx("div",{className:"results-container",children:e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("h2",{children:"CALCULATING RESULTS..."})]})}):o?e.jsx("div",{className:"results-container",children:A?e.jsx(ye,{apiBase:x,onBack:()=>d(!1),onNewSession:u}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"results-header",children:[e.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ PERFORMANCE COMPLETE! ðŸŽ¤"}),e.jsxs("div",{className:"final-score",children:[e.jsx("span",{className:"score-label",children:"FINAL SCORE"}),e.jsx("span",{className:"score-value",style:{color:T(o.totals.total)},children:Math.round(o.totals.total)}),e.jsx("span",{className:"score-grade",style:{color:T(o.totals.total)},children:L(o.totals.total)})]})]}),e.jsxs("div",{className:"score-breakdown",children:[e.jsx("h2",{children:"SCORE BREAKDOWN"}),e.jsxs("div",{className:"score-grid",children:[e.jsxs("div",{className:"score-item",children:[e.jsx("span",{className:"score-label",children:"PITCH"}),e.jsx("div",{className:"score-bar",children:e.jsx("div",{className:"score-fill pitch",style:{width:`${o.totals.pitch}%`}})}),e.jsx("span",{className:"score-value",children:Math.round(o.totals.pitch)})]}),e.jsxs("div",{className:"score-item",children:[e.jsx("span",{className:"score-label",children:"ENERGY"}),e.jsx("div",{className:"score-bar",children:e.jsx("div",{className:"score-fill energy",style:{width:`${o.totals.energy}%`}})}),e.jsx("span",{className:"score-value",children:Math.round(o.totals.energy)})]})]})]}),o.badges&&o.badges.length>0&&e.jsxs("div",{className:"badges-section",children:[e.jsx("h2",{children:"ðŸ† BADGES EARNED ðŸ†"}),e.jsx("div",{className:"badges-grid",children:o.badges.map((t,r)=>e.jsxs("div",{className:"badge",children:[e.jsxs("div",{className:"badge-icon",children:[t.name==="Combo King"&&"ðŸ‘‘",t.name==="Mic Melter"&&"ðŸ”¥",t.name==="Smooth Operator"&&"ðŸŽµ"]}),e.jsxs("div",{className:"badge-info",children:[e.jsx("h3",{children:t.name}),e.jsx("p",{children:t.description})]})]},r))})]}),o.graphs&&e.jsxs("div",{className:"charts-section",children:[e.jsx("h2",{children:"ðŸ“Š PERFORMANCE ANALYSIS"}),e.jsxs("div",{className:"chart-container",children:[e.jsx("h3",{children:"Pitch Timeline"}),e.jsx("div",{className:"chart",children:e.jsx("svg",{width:"100%",height:"200",className:"pitch-chart",children:o.graphs.pitchTimeline.map((t,r)=>{const p=Math.max(...o.graphs.pitchTimeline.map(W=>W.time||0))||1,_=(t.time||0)/p*100,Y=100-(t.score||0)/100*80;return e.jsx("circle",{cx:`${_}%`,cy:`${Y}%`,r:"2",fill:"#39ff14",opacity:"0.7"},r)})})})]}),e.jsxs("div",{className:"chart-container",children:[e.jsx("h3",{children:"Energy Graph"}),e.jsx("div",{className:"chart",children:e.jsx("svg",{width:"100%",height:"200",className:"energy-chart",children:e.jsx("polyline",{points:(()=>{const t=Math.max(...o.graphs.energyGraph.map(r=>r.time||0))||1;return o.graphs.energyGraph.map(r=>`${(r.time||0)/t*100}%,${100-(r.energy||0)*100}%`).join(" ")})(),fill:"none",stroke:"#ff00e6",strokeWidth:"2"})})})]})]}),o.perPhrase&&o.perPhrase.length>0&&e.jsxs("div",{className:"phrases-section",children:[e.jsx("h2",{children:"ðŸŽµ PHRASE BREAKDOWN"}),e.jsx("div",{className:"phrases-grid",children:o.perPhrase.map((t,r)=>e.jsxs("div",{className:"phrase-item",children:[e.jsxs("div",{className:"phrase-header",children:[e.jsxs("span",{className:"phrase-number",children:["Phrase ",t.phrase+1]}),e.jsxs("span",{className:"phrase-time",children:[t.start.toFixed(1),"s - ",t.end.toFixed(1),"s"]})]}),e.jsxs("div",{className:"phrase-scores",children:[e.jsxs("span",{children:["Pitch: ",Math.round(t.pitchScore)]}),e.jsxs("span",{children:["Energy: ",Math.round(t.energyScore)]})]}),e.jsxs("div",{className:"phrase-total",children:["Total: ",Math.round(t.totalScore)]})]},r))})]}),!v&&e.jsxs("div",{className:"leaderboard-submission",children:[e.jsx("h2",{children:"ðŸ† SUBMIT TO LEADERBOARD"}),e.jsxs("div",{className:"submission-form",children:[e.jsx("input",{type:"text",placeholder:"Enter your name",value:g,onChange:t=>f(t.target.value),className:"name-input",maxLength:20}),e.jsx("button",{className:"retro-button large",onClick:F,disabled:!g.trim(),children:"SUBMIT SCORE"})]})]}),e.jsxs("div",{className:"results-actions",children:[e.jsx("button",{className:"retro-button",onClick:u,children:"ðŸŽµ NEW SONG"}),e.jsx("button",{className:"retro-button",onClick:()=>d(!0),children:"ðŸ“Š LEADERBOARD"})]})]})}):e.jsx("div",{className:"results-container",children:e.jsxs("div",{className:"error",children:[e.jsx("h2",{children:"âŒ RESULTS NOT FOUND"}),e.jsx("button",{className:"retro-button",onClick:u,children:"START NEW SESSION"})]})})}const J="http://localhost:8080";function be(){const[i,h]=n.useState("library"),[x,u]=n.useState(null),[g,f]=n.useState(null),[o,N]=n.useState(""),[y,R]=n.useState(0),[A,d]=n.useState(!1),[v,S]=n.useState(null),b=r=>{u(r),h("mic-check")},F=()=>{h("karaoke")},T=async r=>{try{g?(await fetch(`${J}/sessions/${g}/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)}).catch(p=>console.warn("Failed to save results to backend:",p)),o&&await fetch(`${J}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:g,player_name:o,scores:r.totals,badges:r.badges})}).catch(p=>console.warn("Failed to submit to leaderboard:",p))):console.warn("No session ID, results not saved to backend"),S(r),h("results")}catch(p){console.error("Error in handleSessionComplete:",p),S(r),h("results")}},L=()=>{h("library"),u(null),f(null),N(""),d(!1),S(null)},t=()=>{switch(i){case"library":return e.jsx(ge,{onSongSelect:b,apiBase:J});case"mic-check":return e.jsx(je,{onComplete:F,wsUrl:`ws://localhost:8080/session/${g}`});case"karaoke":return e.jsxs("div",{className:"karaoke-stage",children:[e.jsx(Ee,{songData:x,apiBase:J,onSessionComplete:T,onStartSession:async()=>{try{const r=await fetch(`${J}/sessions/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({song_id:x.id})});if(!r.ok){const _=await r.json();throw console.error("Failed to start session:",_),new Error(_.error||"Failed to start session")}const p=await r.json();f(p.session_id)}catch(r){console.error("Error starting session:",r),alert(`Failed to start session: ${r.message}`),d(!1)}},onTimeUpdate:r=>R(r),isSessionActive:A,onSessionToggle:r=>d(r)}),e.jsx(Se,{referenceData:x==null?void 0:x.reference_data,externalTime:y,isSessionActive:A,onSessionComplete:T})]});case"results":return e.jsx(ve,{sessionId:g,results:v,apiBase:J,onNewSession:L,playerName:o,onPlayerNameChange:N});default:return e.jsx("div",{children:"Unknown screen"})}};return e.jsxs("div",{className:"app",children:[e.jsxs("header",{className:"app-header",children:[e.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ KARAOKE ARCADE ðŸŽ¤"}),e.jsx("div",{className:"status-indicators"})]}),e.jsx("main",{className:"app-main",children:t()}),e.jsx("footer",{className:"app-footer",children:e.jsxs("div",{className:"controls",children:[e.jsx("button",{className:"retro-button",onClick:L,disabled:i==="library",children:"ðŸŽµ SONG LIBRARY"}),e.jsx("button",{className:"retro-button",onClick:()=>h("results"),disabled:!g,children:"ðŸ“Š LEADERBOARD"})]})})]})}const oe=document.querySelector(".loading-screen");oe&&(oe.style.display="none");ne.createRoot(document.getElementById("root")).render(e.jsx(ue.StrictMode,{children:e.jsx(be,{})}));
