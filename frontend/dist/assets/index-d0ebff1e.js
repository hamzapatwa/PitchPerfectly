import{r,a as we,R as Le}from"./vendor-b1791c80.js";(function(){const m=document.createElement("link").relList;if(m&&m.supports&&m.supports("modulepreload"))return;for(const N of document.querySelectorAll('link[rel="modulepreload"]'))u(N);new MutationObserver(N=>{for(const S of N)if(S.type==="childList")for(const a of S.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&u(a)}).observe(document,{childList:!0,subtree:!0});function g(N){const S={};return N.integrity&&(S.integrity=N.integrity),N.referrerPolicy&&(S.referrerPolicy=N.referrerPolicy),N.crossOrigin==="use-credentials"?S.credentials="include":N.crossOrigin==="anonymous"?S.credentials="omit":S.credentials="same-origin",S}function u(N){if(N.ep)return;N.ep=!0;const S=g(N);fetch(N.href,S)}})();var ke={exports:{}},be={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Fe=r,Pe=Symbol.for("react.element"),Ie=Symbol.for("react.fragment"),Be=Object.prototype.hasOwnProperty,He=Fe.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Ge={key:!0,ref:!0,__self:!0,__source:!0};function Me(o,m,g){var u,N={},S=null,a=null;g!==void 0&&(S=""+g),m.key!==void 0&&(S=""+m.key),m.ref!==void 0&&(a=m.ref);for(u in m)Be.call(m,u)&&!Ge.hasOwnProperty(u)&&(N[u]=m[u]);if(o&&o.defaultProps)for(u in m=o.defaultProps,m)N[u]===void 0&&(N[u]=m[u]);return{$$typeof:Pe,type:o,key:S,ref:a,props:N,_owner:He.current}}be.Fragment=Ie;be.jsx=Me;be.jsxs=Me;ke.exports=be;var s=ke.exports,Ee={},Te=we;Ee.createRoot=Te.createRoot,Ee.hydrateRoot=Te.hydrateRoot;function We({onSongSelect:o,apiBase:m}){var T,h,p,E,q,I,X;const[g,u]=r.useState([]),[N,S]=r.useState(!0),[a,f]=r.useState(null);r.useEffect(()=>{O()},[]);const O=async()=>{try{const c=await(await fetch(`${m}/library`)).json();u(c)}catch(v){console.error("Failed to load library:",v)}finally{S(!1)}},P=async v=>{try{const c=await fetch(`${m}/library/${v.id}`);if(!c.ok){const j=await c.json().catch(()=>({}));console.error("Failed to load song details:",j.error||c.statusText),alert(`Failed to load song: ${j.error||c.statusText}`);return}const t=await c.json();f(t),o(t)}catch(c){console.error("Failed to load song details:",c),alert(`Failed to load song: ${c.message}`)}},D=v=>new Date(v).toLocaleDateString();return N?s.jsx("div",{className:"library-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"LOADING LIBRARY..."})]})}):s.jsxs("div",{className:"library-container",children:[s.jsxs("div",{className:"library-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸŽµ SONG LIBRARY ðŸŽµ"}),s.jsx("div",{className:"library-controls",children:s.jsx("button",{className:"retro-button",onClick:O,children:"ðŸ”„ REFRESH"})})]}),s.jsx("div",{className:"library-content",children:g.length===0?s.jsxs("div",{className:"empty-library",children:[s.jsx("h2",{children:"ðŸŽ¤ NO SONGS IN LIBRARY"}),s.jsx("p",{children:"Place preprocessed references and videos to get started."})]}):s.jsx("div",{className:"songs-grid",children:g.map(v=>s.jsxs("div",{className:`song-card ${(a==null?void 0:a.id)===v.id?"selected":""}`,onClick:()=>P(v),children:[s.jsxs("div",{className:"song-info",children:[s.jsx("h3",{className:"song-title",children:v.name}),s.jsxs("p",{className:"song-date",children:["Added: ",D(v.uploaded_at)]}),s.jsx("div",{className:"song-status",children:s.jsx("span",{className:"status-badge ready",children:"âœ… READY"})})]}),s.jsx("div",{className:"song-actions",children:s.jsx("button",{className:"retro-button small",onClick:c=>{c.stopPropagation(),P(v)},children:"ðŸŽ¤ SING"})})]},v.id))})}),a&&s.jsxs("div",{className:"song-details",children:[s.jsxs("h3",{children:["Selected: ",a.name]}),s.jsxs("div",{className:"song-metadata",children:[s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Duration:"}),s.jsxs("span",{className:"value",children:[(h=(T=a.reference_data)==null?void 0:T.duration)==null?void 0:h.toFixed(1),"s"]})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Tempo:"}),s.jsxs("span",{className:"value",children:[(E=(p=a.reference_data)==null?void 0:p.tempo)==null?void 0:E.toFixed(1)," BPM"]})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Key:"}),s.jsx("span",{className:"value",children:(q=a.reference_data)==null?void 0:q.key})]}),s.jsxs("div",{className:"metadata-item",children:[s.jsx("span",{className:"label",children:"Phrases:"}),s.jsx("span",{className:"value",children:(X=(I=a.reference_data)==null?void 0:I.phrases)==null?void 0:X.length})]})]})]})]})}const Ye=({songData:o,apiBase:m,onTimeUpdate:g,onStartSession:u,onSessionComplete:N,isSessionActive:S,onSessionToggle:a})=>{var Se,ye,Ne;const f=r.useRef(null),[O,P]=r.useState(!1),[D,T]=r.useState(0),[h,p]=r.useState(0),[E,q]=r.useState(.7),[I,X]=r.useState(!1),v=r.useRef(null),c=r.useRef(S),t=r.useRef(null),[j,re]=r.useState(!1),[V,z]=r.useState(0),K=r.useRef(0);r.useEffect(()=>{if(K.current=V,c.current=S,j&&t.current&&f.current&&V!==0){const i=f.current.currentTime+V;i>=0&&i<t.current.duration&&(t.current.currentTime=i)}},[V,S,j]);const ae=o!=null&&o.karaoke_video?`${m}${o.karaoke_video.startsWith("/")?"":"/"}${o.karaoke_video}`:null,J=o!=null&&o.reference_vocals?`${m}${o.reference_vocals.startsWith("/")?"":"/"}${o.reference_vocals}`:null,Q=r.useCallback((i,M)=>{if(!f.current)return;const $=f.current,ce=M?M.mediaTime:$.currentTime,e=Math.max(0,ce+K.current);if(T(ce),g&&g(e),j&&t.current&&!t.current.paused&&Math.random()<.2){const n=t.current.currentTime;Math.abs(n-e)>.1&&(t.current.currentTime=e)}!$.paused&&!$.ended&&$.requestVideoFrameCallback&&(v.current=$.requestVideoFrameCallback(Q))},[g,j]),B=r.useCallback(()=>{if(!f.current)return;const i=f.current,M=Math.max(0,i.currentTime+K.current);T(i.currentTime),g&&g(M)},[g]);r.useEffect(()=>{const i=f.current;if(!i)return;const M=()=>{p(i.duration),X(!0),console.log("Video ready:",i.duration,"seconds")},$=()=>{if(P(!0),i.requestVideoFrameCallback&&(v.current=i.requestVideoFrameCallback(Q)),j&&t.current){const n=i.currentTime+K.current;t.current.currentTime=Math.max(0,n),t.current.play().catch(()=>{})}},ce=()=>{P(!1),v.current!==null&&i.cancelVideoFrameCallback&&(i.cancelVideoFrameCallback(v.current),v.current=null),t.current&&!t.current.paused&&t.current.pause()},e=()=>{P(!1),c.current&&a&&a(!1),t.current&&(t.current.pause(),t.current.currentTime=0)};return i.addEventListener("loadedmetadata",M),i.addEventListener("play",$),i.addEventListener("pause",ce),i.addEventListener("ended",e),i.addEventListener("timeupdate",B),()=>{i.removeEventListener("loadedmetadata",M),i.removeEventListener("play",$),i.removeEventListener("pause",ce),i.removeEventListener("ended",e),i.removeEventListener("timeupdate",B),v.current!==null&&i.cancelVideoFrameCallback&&i.cancelVideoFrameCallback(v.current)}},[Q,B,S,a,j]),r.useEffect(()=>{f.current&&(f.current.volume=E)},[E]);const ee=r.useCallback(async()=>{const i=f.current;if(i)try{i.paused?(i.muted&&(console.warn("Video was muted, unmuting..."),i.muted=!1),await i.play(),console.log("Video play started successfully")):(i.pause(),console.log("Video paused"))}catch(M){console.error("Video play/pause error:",M),alert(`Video playback error: ${M.message}`)}},[]),me=r.useCallback(i=>{const M=f.current;if(!M)return;const $=i.currentTarget.getBoundingClientRect(),e=(i.clientX-$.left)/$.width*h,n=Math.max(0,e+K.current);M.currentTime=e,T(e),g&&g(n),t.current&&(t.current.currentTime=n,j&&!M.paused&&t.current.play().catch(()=>{}))},[h,g,j]),ge=async()=>{if(c.current)a&&a(!1),f.current&&!f.current.paused&&f.current.pause(),t.current&&!t.current.paused&&t.current.pause();else if(u&&await u(),a&&a(!0),f.current&&f.current.paused)try{f.current.muted&&(console.warn("Video was muted on session start, unmuting..."),f.current.muted=!1),await f.current.play(),console.log("Auto-play started for session")}catch(i){console.error("Auto-play failed:",i),alert(`Auto-play failed: ${i.message}. Please click play manually.`)}},le=i=>{const M=Math.floor(i/60),$=Math.floor(i%60);return`${M}:${$.toString().padStart(2,"0")}`};return o?s.jsxs("div",{className:"video-karaoke-player",children:[s.jsxs("div",{className:"video-container",children:[s.jsx("video",{ref:f,className:"karaoke-video",src:ae,crossOrigin:"anonymous",playsInline:!0,preload:"auto",children:"Your browser does not support the video tag."}),s.jsx("div",{className:"video-overlay",children:s.jsx("button",{className:"play-pause-overlay",onClick:ee,"aria-label":O?"Pause":"Play",children:O?"â¸ï¸":"â–¶ï¸"})})]}),s.jsxs("div",{className:"playback-controls",children:[s.jsxs("div",{className:"progress-section",children:[s.jsx("span",{className:"time-display",children:le(D)}),s.jsx("div",{className:"progress-bar",onClick:me,children:s.jsx("div",{className:"progress-fill",style:{width:`${D/h*100}%`}})}),s.jsx("span",{className:"time-display",children:le(h)})]}),s.jsxs("div",{className:"control-buttons",children:[s.jsx("button",{className:"control-btn",onClick:ee,disabled:!I,children:O?"â¸ï¸ PAUSE":"â–¶ï¸ PLAY"}),s.jsx("button",{className:`control-btn ${S?"active":""}`,onClick:ge,disabled:!I,children:S?"â¹ï¸ STOP SESSION":"ðŸŽ¤ START SESSION"}),s.jsxs("div",{className:"volume-control",children:[s.jsx("span",{className:"volume-icon",children:"ðŸ”Š"}),s.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:E,onChange:i=>q(parseFloat(i.target.value)),className:"volume-slider"})]}),s.jsxs("div",{className:"sync-control",children:[s.jsx("span",{className:"sync-icon",title:"Video/Vocals Sync Offset",children:"â±ï¸"}),s.jsxs("span",{className:"sync-label",children:[V>0?"+":"",V.toFixed(2),"s"]}),s.jsx("input",{type:"range",min:"-3",max:"3",step:"0.05",value:V,onChange:i=>z(parseFloat(i.target.value)),className:"sync-slider"})]}),J&&s.jsx("button",{className:`control-btn ${j?"active":""}`,onClick:()=>{var M,$;const i=!j;re(i),t.current&&(t.current.currentTime=Math.max(0,(((M=f.current)==null?void 0:M.currentTime)||0)+K.current),i&&!(($=f.current)!=null&&$.paused)?t.current.play().catch(()=>{}):t.current.pause())},disabled:!I,children:j?"ðŸ”‡ MUTE REF":"ðŸ”ˆ PLAY REF"})]}),s.jsxs("div",{className:"song-info",children:[s.jsx("h3",{children:o.name||o.song_name||o.title||"Untitled Song"}),s.jsxs("div",{className:"song-metadata",children:[((Se=o.reference_data)==null?void 0:Se.tempo)&&s.jsxs("span",{className:"metadata-item",children:["â™© ",Math.round(o.reference_data.tempo)," BPM"]}),((ye=o.reference_data)==null?void 0:ye.key)&&s.jsxs("span",{className:"metadata-item",children:["ðŸŽ¹ ",o.reference_data.key]}),((Ne=o.reference_data)==null?void 0:Ne.duration)&&s.jsxs("span",{className:"metadata-item",children:["â±ï¸ ",Math.floor(o.reference_data.duration/60),":",String(Math.floor(o.reference_data.duration%60)).padStart(2,"0")]})]})]})]}),J&&s.jsx("audio",{ref:t,src:J,crossOrigin:"anonymous"})]}):s.jsx("div",{className:"video-karaoke-player",children:s.jsx("div",{className:"no-song",children:s.jsx("p",{children:"No song selected"})})})},qe=({referenceData:o,externalTime:m,isSessionActive:g,onSessionComplete:u})=>{const N=r.useRef(null),S=r.useRef(null),a=r.useRef(null),f=r.useRef(null),O=r.useRef(g);r.useEffect(()=>{O.current=g},[g]);const[P,D]=r.useState({total:0,pitch:0,energy:0}),[T,h]=r.useState({frequency:0,confidence:0,centsError:0,combo:0,energyMatch:0}),p=r.useRef({pitchSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,currentCombo:0,frequencies:[],energies:[]}),E=r.useRef(null),q=r.useRef(!1),I=r.useRef({detectedOffset:0,confidence:0,samples:[]}),X=r.useRef({minEnergySeen:1/0,maxEnergySeen:0,initialized:!1}),v=r.useRef({centsErrorBuffer:[],maxBufferSize:10}),c=r.useRef(g),t={PITCH_WEIGHT:.3,ENERGY_WEIGHT:.7,PITCH_PERFECT_CENTS:50,PITCH_GOOD_CENTS:100,PITCH_ACCEPTABLE_CENTS:200,KEY_SHIFT_MIN_SAMPLES:10,KEY_SHIFT_TOLERANCE:100,KEY_SHIFT_MAX_OFFSET:200,ENERGY_MIN_THRESHOLD:.005,ENERGY_SMOOTHING_WINDOW:5,COMBO_THRESHOLD:.95,COMBO_BREAK_THRESHOLD:.6,EMA_ALPHA:.2,BACKBUFFER_MS:350,PITCH_FLOOR:.15,ENERGY_FLOOR:.1,MIN_CONFIDENCE:.2,LOW_CONFIDENCE_FLOOR:.3},j=r.useCallback(async()=>{try{console.log("Initializing audio processing..."),S.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:48e3,latencyHint:"interactive"});const e=S.current;e.state==="suspended"&&(await e.resume(),console.log("Audio context resumed from suspended state"));try{await e.audioWorklet.addModule("/workers/pitch-processor.js"),console.log("âœ… AudioWorklet loaded successfully")}catch(d){console.warn("Failed to load AudioWorklet, using fallback:",d),console.log("Continuing without AudioWorklet - basic audio processing only")}const n=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!1,sampleRate:48e3,channelCount:1}}).catch(async d=>(console.warn("Failed to get microphone with constraints, trying fallback:",d),await navigator.mediaDevices.getUserMedia({audio:!0})));f.current=n;const l=e.createMediaStreamSource(n);try{const d=new AudioWorkletNode(e,"pitch-processor");a.current=d,d.port.onmessage=b=>{b.data.type==="audio-data"&&re(b.data)},l.connect(d),console.log("âœ… AudioWorklet processing initialized")}catch(d){console.warn("AudioWorklet failed, using basic audio monitoring:",d);const b=e.createAnalyser();l.connect(b);const x=setInterval(()=>{O.current?re({frequency:440,confidence:.8,energy:.5,centroid:1e3,aecReduction:.1,timestamp:Date.now()}):clearInterval(x)},100);console.log("âœ… Basic audio monitoring initialized")}}catch(e){console.error("Failed to initialize audio:",e),e.name==="NotAllowedError"?alert("Microphone access denied. Please allow microphone access and refresh the page."):e.name==="NotFoundError"?alert("No microphone found. Please connect a microphone and refresh the page."):e.name==="NotSupportedError"?alert("AudioWorklet not supported. Please use HTTPS or a modern browser (Chrome, Firefox, Safari)."):alert(`Audio initialization failed: ${e.message}. Please check your microphone and browser settings.`),h(n=>({...n,frequency:0,confidence:0,error:e.message}))}},[]),re=r.useCallback(e=>{if(console.log("ðŸŽ¤ Audio data received:",e),!O.current||!o){console.log("Session not active or no reference data");return}const{frequency:n,confidence:l,energy:d,centroid:b,aecReduction:x}=e,C=m,y=V(C);if(!y)return;const A=n>0&&l>=t.MIN_CONFIDENCE&&y.f0>0,R=A?ae(n,l,y,C):null,G=A?J(d,y):null,w=R===null?0:t.PITCH_WEIGHT,U=G===null?0:t.ENERGY_WEIGHT,W=w+U,L=W>0?((R??0)*w+(G??0)*U)/W:null;L!==null&&B(L);const H=1e4;p.current.pitchSamples.push(R),p.current.energySamples.push(G),p.current.timestamps.push(C),p.current.frequencies.push(n),p.current.energies.push(d),p.current.pitchSamples.length>H&&(p.current.pitchSamples.shift(),p.current.energySamples.shift(),p.current.timestamps.shift(),p.current.frequencies.shift(),p.current.energies.shift());const k=Q(n,y.f0);h(Y=>({frequency:n,confidence:l,centsError:k,combo:Y.combo,energyMatch:G})),D(Y=>({total:L!==null?ee(Y.total,L*100,t.EMA_ALPHA):Y.total,pitch:R!==null?ee(Y.pitch,R*100,t.EMA_ALPHA):Y.pitch,energy:G!==null?ee(Y.energy,G*100,t.EMA_ALPHA):Y.energy}))},[o,m]),V=r.useCallback(e=>{if(!o||!o.f0_ref_on_k)return null;const n=o.fps||50,l=Math.floor(e*n);if(l<0||l>=o.f0_ref_on_k.length)return null;const d=o.f0_ref_on_k[l],b=o.beats_k||[],x=b.reduce((A,R)=>Math.abs(R-e)<Math.abs(A-e)?R:A,b[0]||0),C=o.loudness_ref||[],y=C[Math.floor(l*C.length/o.f0_ref_on_k.length)];return{f0:(d==null?void 0:d.f0)||0,conf:(d==null?void 0:d.conf)||0,nearestBeat:x,beatDistance:Math.abs(e-x),loudness:(y==null?void 0:y.LUFS)||-30}},[o]),z=(e,n,l)=>1/(1+Math.exp(-(e-n)/l)),K=e=>{const n=z(e,.3,.1);return t.PITCH_FLOOR+n*(1-t.PITCH_FLOOR)},ae=r.useCallback((e,n,l,d)=>{const b=z(e,20,10),x=z(l.f0,20,10),C=b*x,y=Math.max(e,.1),A=Math.max(l.f0,.1);let R=Q(y,A);I.current.samples.push(R);const G=20;if(I.current.samples.length>G&&I.current.samples.shift(),I.current.samples.length>t.KEY_SHIFT_MIN_SAMPLES){const de=me(I.current.samples),oe=Math.tanh((Math.abs(de)-t.KEY_SHIFT_TOLERANCE)/50);oe>0&&(R-=de*Math.max(0,oe))}v.current.centsErrorBuffer.push(R),v.current.centsErrorBuffer.length>v.current.maxBufferSize&&v.current.centsErrorBuffer.shift();const w=me(v.current.centsErrorBuffer),U=Math.abs(w),W=220,L=Math.exp(-U/W),H=t.PITCH_FLOOR+(1-t.PITCH_FLOOR)*L,k=K(n);return H*k*C+t.PITCH_FLOOR*(1-C)},[]),J=r.useCallback((e,n)=>{const l=X.current;l.initialized||(l.minEnergySeen=Math.max(e,1e-6),l.maxEnergySeen=Math.max(e,1e-6),l.initialized=!0);const d=.05;e>l.maxEnergySeen&&(l.maxEnergySeen=e),e>1e-6&&e<l.minEnergySeen&&(l.minEnergySeen=l.minEnergySeen*(1-d)+e*d);const b=1e-10,x=Math.log10(e+b),C=Math.log10(l.minEnergySeen+b),y=Math.log10(l.maxEnergySeen+b),A=Math.max(y-C,.01);let R=(x-C)/A;R=Math.tanh(R*2);const G=t.ENERGY_FLOOR+(1-t.ENERGY_FLOOR)*(R+1)/2,w=z(e,t.ENERGY_MIN_THRESHOLD,.002);return t.ENERGY_FLOOR*(1-w)+G*w},[]),Q=(e,n)=>e===0||n===0?0:1200*Math.log2(e/n),B=e=>{if(e>=t.COMBO_THRESHOLD){if(q.current)return;E.current&&(clearTimeout(E.current),E.current=null);const n=p.current.currentCombo+1;p.current.currentCombo=n,p.current.combos.push(n),p.current.maxCombo=Math.max(p.current.maxCombo,n),h(l=>({...l,combo:n}))}else p.current.currentCombo>0&&(p.current.currentCombo=0,q.current=!0,E.current&&clearTimeout(E.current),E.current=setTimeout(()=>{h(n=>({...n,combo:0})),q.current=!1,E.current=null},1500)),p.current.combos.push(0)},ee=(e,n,l)=>l*n+(1-l)*e,me=e=>{if(e.length===0)return 0;const n=[...e].sort((d,b)=>d-b),l=Math.floor(n.length/2);return n.length%2===0?(n[l-1]+n[l])/2:n[l]};r.useEffect(()=>{const e=N.current;if(!e)return;const n=e.getContext("2d",{alpha:!1}),l=e.width,d=e.height;let b=null,x=0;const y=1e3/30,A=R=>{R-x>=y&&(n.fillStyle="#000",n.fillRect(0,0,l,d),ge(n,l,d),Se(n,l,d),ye(n,l,d),Ne(n),x=R),b=requestAnimationFrame(A)};return b=requestAnimationFrame(A),()=>{b!==null&&cancelAnimationFrame(b)}},[T,P,o,m]);const ge=(e,n,l)=>{const d=l*.35,b=l*.38,x=30,C=n-60,y=n/2;e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(x,d,C,b),e.strokeStyle="rgba(0, 255, 255, 0.2)",e.lineWidth=1;const A=[82.4,164.8,329.6,659.2];for(let _ of A){const F=le(_,d,b);e.beginPath(),e.moveTo(x,F),e.lineTo(x+C,F),e.stroke()}if(e.strokeStyle="#0ff",e.lineWidth=2,e.strokeRect(x,d,C,b),!o||!o.f0_ref_on_k)return;const R=3,G=.5,w=m,U=w-G,W=w+R,L=o.f0_ref_on_k;let H=0,k=L.length;for(;H<k;){const _=H+k>>1;L[_].t<U?H=_+1:k=_}k=L.length;let Y=H;for(;Y<k;){const _=Y+k>>1;L[_].t<=W?Y=_+1:k=_}const de=[];for(let _=H;_<k;_++){const F=L[_];F.f0>0&&F.conf>.3&&de.push(F)}const oe=[];let ne=null;const _e=1200;for(let _=0;_<de.length;_++){const F=de[_];if(!ne)ne={startTime:F.t,endTime:F.t,f0:F.f0,conf:F.conf};else{const se=F.t-ne.endTime,ue=Math.abs(_e*Math.log2(F.f0/ne.f0));se<.1&&ue<50?(ne.endTime=F.t,ne.f0=(ne.f0+F.f0)*.5):(oe.push(ne),ne={startTime:F.t,endTime:F.t,f0:F.f0,conf:F.conf})}}ne&&oe.push(ne),oe.forEach(_=>{const F=le(_.f0,d,b),se=8,ue=_.startTime-w,xe=C/(R+G),ve=y+ue*xe,Oe=_.endTime-_.startTime,Ce=Math.max(4,Oe*xe),je=_.startTime<=w&&_.endTime>=w,Ae=Math.abs(_.startTime-w)<.2;if(ve+Ce>=x&&ve<=x+C){je?(e.fillStyle="#ff0",e.shadowBlur=15,e.shadowColor="#ff0"):Ae?(e.fillStyle="#f0f",e.shadowBlur=10,e.shadowColor="#f0f"):(e.fillStyle="rgba(0, 255, 255, 0.6)",e.shadowBlur=0);const Z=Math.max(x,ve),fe=Math.min(Ce,x+C-Z),te=F-se/2,ie=2;e.beginPath(),e.moveTo(Z+ie,te),e.lineTo(Z+fe-ie,te),e.quadraticCurveTo(Z+fe,te,Z+fe,te+ie),e.lineTo(Z+fe,te+se-ie),e.quadraticCurveTo(Z+fe,te+se,Z+fe-ie,te+se),e.lineTo(Z+ie,te+se),e.quadraticCurveTo(Z,te+se,Z,te+se-ie),e.lineTo(Z,te+ie),e.quadraticCurveTo(Z,te,Z+ie,te),e.closePath(),e.fill(),e.shadowBlur=0,e.strokeStyle=je?"#fff":"rgba(0, 255, 255, 0.8)",e.lineWidth=je?2:1,e.stroke()}}),e.strokeStyle="#fff",e.lineWidth=2,e.setLineDash([5,5]),e.beginPath(),e.moveTo(y,d),e.lineTo(y,d+b),e.stroke(),e.setLineDash([]);const pe=d+b+12;if(e.font="9px monospace",e.textAlign="center",e.fillStyle="#0f0",e.beginPath(),e.arc(y-60,pe,5,0,Math.PI*2),e.fill(),e.fillStyle="#fff",e.textAlign="left",e.fillText("= YOU",y-53,pe+3),e.strokeStyle="#f0f",e.lineWidth=2,e.beginPath(),e.moveTo(y+20,pe),e.lineTo(y+35,pe),e.stroke(),e.fillStyle="#fff",e.fillText("= TARGET",y+38,pe+3),T.frequency>0&&T.confidence>.2){const _=le(T.frequency,d,b),F=V(m);if(F&&F.f0>0){const ue=le(F.f0,d,b);e.strokeStyle=T.confidence>.5?"rgba(0, 255, 0, 0.5)":"rgba(255, 255, 0, 0.5)",e.lineWidth=2,e.beginPath(),e.moveTo(y,_),e.lineTo(y,ue),e.stroke(),e.strokeStyle="#f0f",e.fillStyle="#f0f",e.shadowBlur=12,e.shadowColor="#f0f",e.lineWidth=3,e.beginPath(),e.moveTo(y-25,ue),e.lineTo(y+25,ue),e.stroke(),e.font="bold 11px monospace",e.textAlign="left",e.fillText("TARGET",y+30,ue+4),e.shadowBlur=0}const se=T.confidence>.5?"#0f0":"#ff0";e.fillStyle=se,e.strokeStyle="#fff",e.shadowBlur=15,e.shadowColor=se,e.beginPath(),e.arc(y,_,10,0,Math.PI*2),e.fill(),e.lineWidth=2,e.stroke(),e.font="bold 11px monospace",e.textAlign="right",e.fillStyle=se,e.fillText("YOU",y-15,_+4),e.shadowBlur=0}},le=(e,n,l)=>{const x=Math.max(80,Math.min(1e3,e)),C=Math.log2(x),y=Math.log2(80),A=Math.log2(1e3),R=(C-y)/(A-y);return n+l*(1-R)},Se=(e,n,l)=>{const d=l*.78,b=n-60,x=18,C=30;e.fillStyle="#333",e.fillRect(C,d,b,x),e.strokeStyle="#fff",e.lineWidth=2,e.beginPath(),e.moveTo(n/2,d),e.lineTo(n/2,d+x),e.stroke();const y=50,A=T.centsError/y*(b/2),R=n/2+A,G=Math.abs(T.centsError);let w="#0f0";G>25&&(w="#ff0"),G>50&&(w="#f00"),e.fillStyle=w,e.fillRect(R-3,d,6,x),e.fillStyle="#fff",e.font="11px monospace",e.textAlign="center",e.fillText(`${T.centsError.toFixed(0)} Â¢`,n/2,d+x+15)},ye=(e,n,l)=>{T.combo>=2&&(e.fillStyle="#ff0",e.font="bold 32px monospace",e.textAlign="center",e.fillText(`${T.combo}x`,n/2,l*.12),e.font="bold 20px monospace",e.fillText("COMBO!",n/2,l*.16))},Ne=(e,n,l)=>{const x=y=>y>=90?"#0f0":y>=75?"#0ff":y>=60?"#ff0":"#f80",C=(y,A,R,G)=>{e.font="bold 12px monospace",e.fillStyle="#888",e.textAlign="left",e.fillText(y,15,R-8);const w=G||x(A);e.shadowBlur=15,e.shadowColor=w,e.font="bold 32px monospace",e.fillStyle=w,e.fillText(`${A.toFixed(0)}%`,15,R+20),e.shadowBlur=0;const U=120,W=6,L=15,H=R+26;e.fillStyle="#222",e.fillRect(L,H,U,W);const k=e.createLinearGradient(L,H,L+U,H);A>=90?(k.addColorStop(0,"#0f0"),k.addColorStop(1,"#0ff")):A>=75?(k.addColorStop(0,"#0ff"),k.addColorStop(1,"#08f")):A>=60?(k.addColorStop(0,"#ff0"),k.addColorStop(1,"#f80")):(k.addColorStop(0,"#f80"),k.addColorStop(1,"#f00")),e.fillStyle=k;const Y=A/100*U;e.fillRect(L,H,Y,W),e.strokeStyle=w,e.lineWidth=1,e.strokeRect(L,H,U,W)};e.font="bold 14px monospace",e.fillStyle="#fff",e.textAlign="left",e.fillText("TOTAL SCORE",15,30),e.shadowBlur=20,e.shadowColor=x(P.total),e.font="bold 42px monospace",e.fillStyle=x(P.total),e.fillText(`${P.total.toFixed(0)}%`,15,30+38),e.shadowBlur=0,e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.moveTo(15,30+50),e.lineTo(15+140,30+50),e.stroke(),C("PITCH",P.pitch,30+70,null),C("ENERGY",P.energy,30+125,null)},i=r.useCallback(e=>e.filter(n=>typeof n=="number"&&Number.isFinite(n)),[]),M=r.useCallback(e=>{const n=i(e);return n.length===0?0:n.reduce((l,d)=>l+d,0)/n.length},[i]),$=r.useCallback(e=>{const n=i(e);if(n.length===0)return 0;const l=M(n),d=n.reduce((b,x)=>b+Math.pow(x-l,2),0)/n.length;return Math.sqrt(d)},[i,M]),ce=r.useCallback(()=>{const e=p.current;if(e.timestamps.length===0)return console.warn("No performance data collected"),null;const n=M(e.pitchSamples)*100,l=M(e.energySamples)*100,d=n*t.PITCH_WEIGHT+l*t.ENERGY_WEIGHT,b=e.timestamps.map((W,L)=>{const H=e.pitchSamples[L];return typeof H!="number"?null:{time:W,score:H*100}}).filter(Boolean),x=e.timestamps.map((W,L)=>({time:W,energy:e.energies[L]})),C=[];e.maxCombo>=5&&C.push({name:"Combo King",description:`${e.maxCombo}x combo streak!`});const y=e.energySamples.length>0?1-$(e.energySamples)/(M(e.energySamples)+.001):0,A=M(e.energySamples);y>=.5&&A>=.8&&C.push({name:"Mic Melter",description:"Sustained energy!"}),(e.pitchSamples.length>0?1-$(e.pitchSamples)/(M(e.pitchSamples)+.001):0)>=.65&&n>=65&&C.push({name:"Smooth Operator",description:"Consistent pitch!"});const G=[],w=10,U=Math.max(...e.timestamps);for(let W=0;W<U;W+=w){const L=Math.min(W+w,U),H=e.timestamps.map((k,Y)=>k>=W&&k<L?Y:-1).filter(k=>k>=0);if(H.length>0){const k=M(H.map(oe=>e.pitchSamples[oe]))*100,Y=M(H.map(oe=>e.energySamples[oe]))*100,de=k*t.PITCH_WEIGHT+Y*t.ENERGY_WEIGHT;G.push({phrase:Math.floor(W/w),start:W,end:L,pitchScore:k,energyScore:Y,totalScore:de})}}return{totals:{total:d,pitch:n,energy:l,motion:0},badges:C,graphs:{pitchTimeline:b,energyGraph:x},perPhrase:G,performance_data:e}},[]);return r.useEffect(()=>{if(c.current&&!g&&p.current.timestamps.length>0){console.log("ðŸŽ¤ Session ended, computing final results...");const e=ce();e&&u&&(console.log("ðŸŽ¤ Final results:",e),u(e))}c.current=g},[g,ce,u]),r.useEffect(()=>(O.current?(console.log("ðŸŽ¤ Session active, initializing audio processing..."),c.current||(console.log("ðŸŽ¤ Resetting performance data for new session"),p.current={pitchSamples:[],energySamples:[],timestamps:[],combos:[],maxCombo:0,currentCombo:0,frequencies:[],energies:[]},E.current&&(clearTimeout(E.current),E.current=null),q.current=!1,h(e=>({...e,combo:0})),I.current={detectedOffset:0,confidence:0,samples:[]},X.current={minEnergySeen:1/0,maxEnergySeen:0,initialized:!1},v.current={centsErrorBuffer:[],maxBufferSize:10}),S.current?(console.log("ðŸŽ¤ Audio context already exists, ensuring processing is active"),a.current?console.log("ðŸŽ¤ AudioWorklet is active"):(console.log("ðŸŽ¤ AudioWorklet not active, reinitializing..."),j())):j()):(console.log("ðŸŽ¤ Session inactive, stopping audio processing"),f.current&&(f.current.getTracks().forEach(e=>e.stop()),f.current=null),S.current&&S.current.state!=="closed"&&(S.current.close().catch(()=>{}),S.current=null),a.current=null,E.current&&(clearTimeout(E.current),E.current=null),q.current=!1),()=>{f.current&&f.current.getTracks().forEach(e=>e.stop()),S.current&&S.current.state!=="closed"&&S.current.close().catch(()=>{}),E.current&&(clearTimeout(E.current),E.current=null),q.current=!1}),[g,j]),s.jsxs("div",{className:"live-hud",children:[s.jsx("canvas",{ref:N,width:500,height:700,className:"hud-canvas"}),I.current.confidence>.5&&s.jsxs("div",{className:"key-shift-indicator",children:["Key shifted: ",I.current.detectedOffset>0?"+":"",I.current.detectedOffset.toFixed(0)," cents"]})]})};function $e({onComplete:o}){const[m,g]=r.useState(null),[u,N]=r.useState(0),[S,a]=r.useState(!1),f=r.useRef(null),O=r.useRef(null),P=r.useRef(null),D=r.useRef(null);r.useEffect(()=>()=>{D.current&&cancelAnimationFrame(D.current),P.current&&P.current.getTracks().forEach(c=>c.stop())},[]);const T=async()=>{try{const c=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});P.current=c,g(!0),h(c)}catch(c){console.error("Microphone access denied:",c),g(!1)}},h=c=>{try{f.current=new(window.AudioContext||window.webkitAudioContext),f.current.state==="suspended"&&f.current.resume().catch(()=>{}),O.current=f.current.createAnalyser(),O.current.fftSize=256,O.current.smoothingTimeConstant=.8,f.current.createMediaStreamSource(c).connect(O.current),p()}catch(t){console.error("Audio analysis setup failed:",t)}},p=()=>{const c=new Uint8Array(O.current.frequencyBinCount),t=new Uint8Array(O.current.fftSize),j=()=>{if(O.current){O.current.getByteFrequencyData(c),O.current.getByteTimeDomainData(t);let re=0;for(let B=0;B<c.length;B++)re+=c[B]*c[B];const V=Math.sqrt(re/c.length);let z=0;for(let B=0;B<t.length;B++){const ee=t[B]-128;z+=ee*ee}const K=Math.sqrt(z/t.length),ae=Math.max(V*.5,K),J=Math.min(ae/32,1),Q=Math.max(J,.02);N(Q),D.current=requestAnimationFrame(j)}};j()},E=()=>a(!0),q=()=>a(!1),I=()=>o(),X=()=>u<.1?"#ff3d00":u<.3?"#ffd700":u<.7?"#39ff14":"#ff00e6",v=()=>u<.1?"TOO QUIET":u<.3?"GETTING THERE":u<.7?"PERFECT":"TOO LOUD";return s.jsxs("div",{className:"mic-check-container",children:[s.jsxs("div",{className:"mic-check-header",children:[s.jsx("h2",{className:"neon-text",children:"ðŸŽ¤ MIC CHECK ðŸŽ¤"}),s.jsx("p",{children:"Let's make sure everything is working perfectly!"})]}),s.jsxs("div",{className:"mic-check-content",children:[s.jsxs("div",{className:"mic-section",children:[s.jsx("h3",{children:"Microphone"}),m===null&&s.jsx("button",{className:"retro-button large",onClick:T,children:"ðŸŽ¤ ENABLE MICROPHONE"}),m===!1&&s.jsxs("div",{className:"permission-denied",children:[s.jsx("p",{children:"âŒ Microphone access denied"}),s.jsx("p",{children:"Please allow microphone access to continue"}),s.jsx("button",{className:"retro-button",onClick:T,children:"TRY AGAIN"})]}),m===!0&&s.jsxs("div",{className:"mic-status",children:[s.jsx("div",{className:"audio-level-display",children:s.jsx("div",{className:"audio-level-bar",style:{height:`${u*100}%`,backgroundColor:X()}})}),s.jsxs("div",{className:"audio-level-info",children:[s.jsx("p",{className:`level-text ${v().replace(" ","-").toLowerCase()}`,children:v()}),s.jsxs("p",{className:"level-value",children:[(u*100).toFixed(0),"%"]})]}),s.jsx("div",{className:"mic-controls",children:S?s.jsx("button",{className:"retro-button",onClick:q,children:"â¹ï¸ STOP LISTENING"}):s.jsx("button",{className:"retro-button",onClick:E,children:"ðŸŽµ START LISTENING"})})]})]}),s.jsxs("div",{className:"instructions",children:[s.jsx("h4",{children:"Instructions:"}),s.jsxs("ul",{children:[s.jsx("li",{children:"ðŸŽ¤ Enable microphone and test your audio levels"}),s.jsx("li",{children:"ðŸŽµ Sing a few notes to test your setup"}),s.jsx("li",{children:"âœ¨ When ready, proceed to the live performance!"})]})]}),m===!0&&s.jsxs("div",{className:"proceed-section",children:[s.jsx("button",{className:"retro-button large proceed",onClick:I,disabled:u<.02,children:"ðŸš€ START PERFORMANCE"}),u<.02&&s.jsx("p",{className:"warning",children:"âš ï¸ Please test your microphone first"})]})]})]})}function De({apiBase:o,onBack:m,onNewSession:g}){const[u,N]=r.useState([]),[S,a]=r.useState(!0);r.useEffect(()=>{f()},[]);const f=r.useCallback(async()=>{try{const p=await(await fetch(`${o}/leaderboard?limit=20`)).json();N(p)}catch(h){console.error("Failed to load leaderboard:",h)}finally{a(!1)}},[o]),O=r.useCallback(h=>h===1?"ðŸ¥‡":h===2?"ðŸ¥ˆ":h===3?"ðŸ¥‰":`#${h}`,[]),P=r.useCallback(h=>h>=90?"#39ff14":h>=80?"#ffd700":h>=70?"#ff9500":"#ff3d00",[]),D=r.useCallback(h=>{const p=new Date(h);return p.toLocaleDateString()+" "+p.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},[]),T=r.useMemo(()=>{if(u.length===0)return 0;const h=u.reduce((p,E)=>p+E.total_score,0);return Math.round(h/u.length)},[u]);return S?s.jsx("div",{className:"leaderboard-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"LOADING LEADERBOARD..."})]})}):s.jsxs("div",{className:"leaderboard-container",children:[s.jsxs("div",{className:"leaderboard-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸ† LEADERBOARD ðŸ†"}),s.jsx("p",{className:"leaderboard-subtitle",children:"Top performers in the arcade!"})]}),s.jsx("div",{className:"leaderboard-content",children:u.length===0?s.jsxs("div",{className:"empty-leaderboard",children:[s.jsx("h2",{children:"ðŸŽ¤ NO SCORES YET"}),s.jsx("p",{children:"Be the first to submit a score!"}),s.jsx("button",{className:"retro-button large",onClick:g,children:"START SINGING"})]}):s.jsx("div",{className:"leaderboard-list",children:u.map((h,p)=>s.jsxs("div",{className:`leaderboard-entry ${p<3?"top-three":""}`,children:[s.jsx("div",{className:"rank",children:s.jsx("span",{className:"rank-icon",children:O(p+1)})}),s.jsxs("div",{className:"player-info",children:[s.jsx("h3",{className:"player-name",children:h.player_name}),s.jsx("p",{className:"play-date",children:D(h.played_at)})]}),s.jsxs("div",{className:"score-info",children:[s.jsx("div",{className:"total-score",style:{color:P(h.total_score)},children:Math.round(h.total_score)}),s.jsxs("div",{className:"score-breakdown",children:[s.jsxs("span",{children:["P: ",Math.round(h.pitch_score)]}),s.jsxs("span",{children:["E: ",Math.round(h.energy_score)]})]})]}),s.jsx("div",{className:"badges",children:h.badges&&h.badges.length>0&&s.jsx("div",{className:"badge-list",children:h.badges.map((E,q)=>s.jsxs("span",{className:"badge-mini",children:[E.name==="Combo King"&&"ðŸ‘‘",E.name==="Mic Melter"&&"ðŸ”¥",E.name==="Smooth Operator"&&"ðŸŽµ"]},q))})})]},h.id))})}),s.jsxs("div",{className:"leaderboard-actions",children:[s.jsx("button",{className:"retro-button",onClick:m,children:"â† BACK TO RESULTS"}),s.jsx("button",{className:"retro-button",onClick:g,children:"ðŸŽµ NEW SONG"}),s.jsx("button",{className:"retro-button",onClick:f,children:"ðŸ”„ REFRESH"})]}),s.jsxs("div",{className:"leaderboard-stats",children:[s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"TOTAL PLAYERS"}),s.jsx("span",{className:"stat-value",children:u.length})]}),s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"HIGHEST SCORE"}),s.jsx("span",{className:"stat-value",children:u.length>0?Math.round(u[0].total_score):0})]}),s.jsxs("div",{className:"stat",children:[s.jsx("span",{className:"stat-label",children:"AVERAGE SCORE"}),s.jsx("span",{className:"stat-value",children:T})]})]})]})}function Ve({sessionId:o,results:m,apiBase:g,onNewSession:u,playerName:N,onPlayerNameChange:S}){const[a,f]=r.useState(m||null),[O,P]=r.useState(!m&&!!o),[D,T]=r.useState(!1),[h,p]=r.useState(!1),E=r.useCallback(async()=>{try{const j=await(await fetch(`${g}/sessions/${o}/results`)).json();f(j.results||j)}catch(t){console.error("Failed to load results:",t)}finally{P(!1)}},[g,o]);r.useEffect(()=>{m?(f(m),P(!1)):o&&E()},[o,m,E]);const q=r.useCallback(async()=>{if(!N.trim()){alert("Please enter your name!");return}try{(await fetch(`${g}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:o,player_name:N,scores:a.totals,badges:a.badges})})).ok&&(p(!0),T(!0))}catch(t){console.error("Failed to submit to leaderboard:",t),alert("Failed to submit to leaderboard")}},[g,o,N,a]),I=r.useCallback(t=>t>=90?"#39ff14":t>=70?"#ffd700":t>=50?"#ff9500":"#ff3d00",[]),X=r.useCallback(t=>t>=95?"S+":t>=90?"S":t>=85?"A+":t>=80?"A":t>=75?"B+":t>=70?"B":t>=65?"C+":t>=60?"C":t>=50?"D":"F",[]),v=r.useMemo(()=>{var ae;if(!((ae=a==null?void 0:a.graphs)!=null&&ae.pitchTimeline))return null;const t=a.graphs.pitchTimeline;if(t.length===0)return null;const j=t.map(J=>J.time||0),re=Math.max(...j)||1,V=Math.min(...j)||0,z=re-V,K=z<2;return t.map((J,Q)=>{const B=K?Q/(t.length-1||1)*1e3:(J.time-V)/z*1e3,ee=90-(J.score||0)/100*80;return{x:B,y:ee,index:Q}})},[a]),c=r.useMemo(()=>{var Q;if(!((Q=a==null?void 0:a.graphs)!=null&&Q.energyGraph))return null;const t=a.graphs.energyGraph;if(t.length===0)return null;const j=t.map(B=>B.time||0),re=t.map(B=>B.energy||0),V=Math.max(...j)||1,z=Math.min(...j)||0,K=V-z,ae=Math.max(...re)||1,J=K<2;return t.map((B,ee)=>{const me=J?ee/(t.length-1||1)*1e3:(B.time-z)/K*1e3,le=90-(B.energy||0)/ae*80;return`${me},${le}`}).join(" ")},[a]);return O?s.jsx("div",{className:"results-container",children:s.jsxs("div",{className:"loading",children:[s.jsx("div",{className:"spinner"}),s.jsx("h2",{children:"CALCULATING RESULTS..."})]})}):a?s.jsx("div",{className:"results-container",children:D?s.jsx(De,{apiBase:g,onBack:()=>T(!1),onNewSession:u}):s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"results-header",children:[s.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ PERFORMANCE COMPLETE! ðŸŽ¤"}),s.jsxs("div",{className:"final-score",children:[s.jsx("span",{className:"score-label",children:"FINAL SCORE"}),s.jsx("span",{className:"score-value",style:{color:I(a.totals.total)},children:Math.round(a.totals.total)}),s.jsx("span",{className:"score-grade",style:{color:I(a.totals.total)},children:X(a.totals.total)})]})]}),s.jsxs("div",{className:"score-breakdown",children:[s.jsx("h2",{children:"SCORE BREAKDOWN"}),s.jsxs("div",{className:"score-grid",children:[s.jsxs("div",{className:"score-item",children:[s.jsx("span",{className:"score-label",children:"PITCH"}),s.jsx("div",{className:"score-bar",children:s.jsx("div",{className:"score-fill pitch",style:{width:`${a.totals.pitch}%`}})}),s.jsx("span",{className:"score-value",children:Math.round(a.totals.pitch)})]}),s.jsxs("div",{className:"score-item",children:[s.jsx("span",{className:"score-label",children:"ENERGY"}),s.jsx("div",{className:"score-bar",children:s.jsx("div",{className:"score-fill energy",style:{width:`${a.totals.energy}%`}})}),s.jsx("span",{className:"score-value",children:Math.round(a.totals.energy)})]})]})]}),a.badges&&a.badges.length>0&&s.jsxs("div",{className:"badges-section",children:[s.jsx("h2",{children:"ðŸ† BADGES EARNED ðŸ†"}),s.jsx("div",{className:"badges-grid",children:a.badges.map((t,j)=>s.jsxs("div",{className:"badge",children:[s.jsxs("div",{className:"badge-icon",children:[t.name==="Combo King"&&"ðŸ‘‘",t.name==="Mic Melter"&&"ðŸ”¥",t.name==="Smooth Operator"&&"ðŸŽµ"]}),s.jsxs("div",{className:"badge-info",children:[s.jsx("h3",{children:t.name}),s.jsx("p",{children:t.description})]})]},j))})]}),a.graphs&&s.jsxs("div",{className:"charts-section",children:[s.jsx("h2",{children:"ðŸ“Š PERFORMANCE ANALYSIS"}),s.jsxs("div",{className:"chart-container",children:[s.jsx("h3",{children:"Pitch Timeline"}),s.jsx("div",{className:"chart",children:s.jsx("svg",{width:"100%",height:"200",viewBox:"0 0 1000 100",preserveAspectRatio:"none",className:"pitch-chart",children:v==null?void 0:v.map(t=>s.jsx("circle",{cx:t.x,cy:t.y,r:"3",fill:"#39ff14",opacity:"0.7"},t.index))})})]}),s.jsxs("div",{className:"chart-container",children:[s.jsx("h3",{children:"Energy Graph"}),s.jsx("div",{className:"chart",children:s.jsx("svg",{width:"100%",height:"200",viewBox:"0 0 1000 100",preserveAspectRatio:"none",className:"energy-chart",children:c&&s.jsx("polyline",{points:c,fill:"none",stroke:"#ff00e6",strokeWidth:"2"})})})]})]}),a.perPhrase&&a.perPhrase.length>0&&s.jsxs("div",{className:"phrases-section",children:[s.jsx("h2",{children:"ðŸŽµ PHRASE BREAKDOWN"}),s.jsx("div",{className:"phrases-grid",children:a.perPhrase.map((t,j)=>s.jsxs("div",{className:"phrase-item",children:[s.jsxs("div",{className:"phrase-header",children:[s.jsxs("span",{className:"phrase-number",children:["Phrase ",t.phrase+1]}),s.jsxs("span",{className:"phrase-time",children:[t.start.toFixed(1),"s - ",t.end.toFixed(1),"s"]})]}),s.jsxs("div",{className:"phrase-scores",children:[s.jsxs("span",{children:["Pitch: ",Math.round(t.pitchScore)]}),s.jsxs("span",{children:["Energy: ",Math.round(t.energyScore)]})]}),s.jsxs("div",{className:"phrase-total",children:["Total: ",Math.round(t.totalScore)]})]},j))})]}),!h&&s.jsxs("div",{className:"leaderboard-submission",children:[s.jsx("h2",{children:"ðŸ† SUBMIT TO LEADERBOARD"}),s.jsxs("div",{className:"submission-form",children:[s.jsx("input",{type:"text",placeholder:"Enter your name",value:N,onChange:t=>S(t.target.value),className:"name-input",maxLength:20}),s.jsx("button",{className:"retro-button large",onClick:q,disabled:!N.trim(),children:"SUBMIT SCORE"})]})]}),s.jsxs("div",{className:"results-actions",children:[s.jsx("button",{className:"retro-button",onClick:u,children:"ðŸŽµ NEW SONG"}),s.jsx("button",{className:"retro-button",onClick:()=>T(!0),children:"ðŸ“Š LEADERBOARD"})]})]})}):s.jsx("div",{className:"results-container",children:s.jsxs("div",{className:"error",children:[s.jsx("h2",{children:"âŒ RESULTS NOT FOUND"}),s.jsx("button",{className:"retro-button",onClick:u,children:"START NEW SESSION"})]})})}const he=window.location.port==="3000"?"http://localhost:8080":window.location.origin;function ze(){const[o,m]=r.useState("library"),[g,u]=r.useState(null),[N,S]=r.useState(null),[a,f]=r.useState(""),[O,P]=r.useState(0),[D,T]=r.useState(!1),[h,p]=r.useState(null),E=c=>{u(c),m("mic-check")},q=()=>{m("karaoke")},I=async c=>{try{N?(await fetch(`${he}/sessions/${N}/finish`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}).catch(t=>console.warn("Failed to save results to backend:",t)),a&&await fetch(`${he}/leaderboard/submit`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_id:N,player_name:a,scores:c.totals,badges:c.badges})}).catch(t=>console.warn("Failed to submit to leaderboard:",t))):console.warn("No session ID, results not saved to backend"),p(c),m("results")}catch(t){console.error("Error in handleSessionComplete:",t),p(c),m("results")}},X=()=>{m("library"),u(null),S(null),f(""),T(!1),p(null)},v=()=>{switch(o){case"library":return s.jsx(We,{onSongSelect:E,apiBase:he});case"mic-check":return s.jsx($e,{onComplete:q});case"karaoke":return s.jsxs("div",{className:"karaoke-stage",children:[s.jsx(Ye,{songData:g,apiBase:he,onSessionComplete:I,onStartSession:async()=>{try{const c=await fetch(`${he}/sessions/start`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({song_id:g.id})});if(!c.ok){const j=await c.json();throw console.error("Failed to start session:",j),new Error(j.error||"Failed to start session")}const t=await c.json();S(t.session_id)}catch(c){console.error("Error starting session:",c),alert(`Failed to start session: ${c.message}`),T(!1)}},onTimeUpdate:c=>P(c),isSessionActive:D,onSessionToggle:c=>T(c)}),s.jsx(qe,{referenceData:g==null?void 0:g.reference_data,externalTime:O,isSessionActive:D,onSessionComplete:I})]});case"results":return s.jsx(Ve,{sessionId:N,results:h,apiBase:he,onNewSession:X,playerName:a,onPlayerNameChange:f});default:return s.jsx("div",{children:"Unknown screen"})}};return s.jsxs("div",{className:"app",children:[s.jsx("header",{className:"app-header",children:s.jsx("h1",{className:"neon-title",children:"ðŸŽ¤ PitchPerfectly ðŸŽ¤"})}),s.jsx("main",{className:"app-main",children:v()}),s.jsx("footer",{className:"app-footer",children:s.jsxs("div",{className:"controls",children:[s.jsx("button",{className:"retro-button",onClick:X,disabled:o==="library",children:"ðŸŽµ SONG LIBRARY"}),s.jsx("button",{className:"retro-button",onClick:()=>m("results"),disabled:!N,children:"ðŸ“Š LEADERBOARD"})]})})]})}const Re=document.querySelector(".loading-screen");Re&&(Re.style.display="none");Ee.createRoot(document.getElementById("root")).render(s.jsx(Le.StrictMode,{children:s.jsx(ze,{})}));
